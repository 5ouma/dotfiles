#!/usr/bin/env zsh

#==================================================[ Variables ]==================================================#

declare -r githubURL="https://github.com/5ouma/dotfiles.git"
[ -z "$ZDOTDIR" ] && export -r ZDOTDIR="$HOME/.zsh"
[ -z "$dotfiles" ] && declare -r dotfiles="$HOME/.dotfiles"
declare -r packages="$dotfiles/packages"
declare -r scripts="$dotfiles/scripts"
declare -r preferences=("homebrew" "files" "defaults" "apps")
[ -z "$datas" ] && declare -r datas="$dotfiles/datas"
declare -r backup="$dotfiles/backup"

declare doAll=false
declare doneAnything=false
declare nowNum=1
[ -e "$dotfiles" ] && declare -r allNum=$(($(grep -o "echoNumber" "$scripts"/* | wc -l)))

declare -r setupMessage="
 ██████╗   ██████╗  ████████╗ ███████╗ ██╗ ██╗      ███████╗ ███████╗
 ██╔══██╗ ██╔═══██╗ ╚══██╔══╝ ██╔════╝ ██║ ██║      ██╔════╝ ██╔════╝
 ██║  ██║ ██║   ██║    ██║    █████╗   ██║ ██║      █████╗   ███████╗
 ██║  ██║ ██║   ██║    ██║    ██╔══╝   ██║ ██║      ██╔══╝   ╚════██║
 ██████╔╝ ╚██████╔╝    ██║    ██║      ██║ ███████╗ ███████╗ ███████║
 ╚═════╝   ╚═════╝     ╚═╝    ╚═╝      ╚═╝ ╚══════╝ ╚══════╝ ╚══════╝

                     \033[;1mWelcome to dotfiles setup!\033[m
                  \033[;2;4mhttps://github.com/5ouma/dotfiles\033[m
"

#==================================================[ Functions ]==================================================#

getColor() {
  case "$1" in
  red) echo -n 31 ;;
  green) echo -n 32 ;;
  yellow) echo -n 33 ;;
  blue) echo -n 34 ;;
  cyan) echo -n 36 ;;
  gray) echo -n 90 ;;
  esac
}

printc() {
  local -r color="$(getColor "$1")"
  [ "$2" = true ] && local -r isBold=1 || local -r isBold=0
  printf "\033[%s;%sm%s\033[m" "$isBold" "$color" "$3"
}

# Echo with message
echoNumber() {
  printf "$(printc gray false "[$nowNum/$allNum]") %s  %s\n" "$1" "$2"
  ((nowNum++))
}

echoAsk() {
  printf "$(printc blue true "ask") %s: " "$1"
}

echoQue() {
  printf "$(printc gray true "question") %s › " "$1"
}

echoInfo() {
  printf "$(printc cyan true "info") %s\n" "$1"
}

echoResult() {
  if [[ $? = 0 ]]; then
    printf "$(printc green false "success") %s\n" "$1"
    doneAnything=true
  else
    printf "$(printc red false "error") %s\n" "$2"
  fi
  sleep 1
}

echoWarning() {
  printf "$(printc yellow true "warning") %s\n" "$1"
  sleep 0.5
}

echoDone() {
  if "$doneAnything"; then
    print "✨  Setting up successfully!"
  else
    printf "$(printc yellow true "warning") Nothing has changed.\n"
  fi
}

newLine() {
  echo
}

# Wait user input
waitInput() {
  echoAsk "$1 (y/n/other to abort)"
  read -rk 1 run
  newLine
  if [[ "$run" =~ "y|Y" ]]; then
    return 0
  elif [[ "$run" =~ "n|N" ]]; then
    ((nowNum += $(grep -o "echoNumber" "$2" | wc -l)))
    return 1
  else
    newLine
    echoDone
    exit
  fi
}

waitReturn() {
  print "Press RETURN to continue"
  read -rs
}

#==================================================[ Flags ]==================================================#

case "$1" in
"-h" | "--help")
  cat <<EOM
Usage: setup

💻 The most minimal and powerful dotfiles ever.

Flags:
  -h, --help    Print help information
  -y, --yes     Run all configuration
  -s, --set     Set files to home directory
EOM
  exit
  ;;

"-y" | "--yes")
  doAll=true
  ;;

"-s" | "--set")
  source "$scripts/files.zsh" true
  exit
  ;;
esac

#==================================================[ Operations ]==================================================#

# Zsh setting
zstyle ":completion:*:commands" rehash 1

# Display welcome message
[ ! -e "$dotfiles" ] && print "$setupMessage"

# Ask to confirm
echoAsk "Are you sure to start setup? (y/n)"
read -rq && newLine || {
  newLine
  exit
}

# Clone repository
if [[ ! -e "$dotfiles" ]]; then
  echoInfo "Cloning repository into \`~/.dotfiles\`..."
  git clone -q "$githubURL" "$dotfiles"
  declare -r allNum=$(($(grep -o "echoNumber" "$scripts"/* | wc -l)))
fi
newLine

# Apply preference
for script in "${preferences[@]}"; do
  source "$scripts/$script.zsh" false
  newLine
done

# Done!
echoDone
