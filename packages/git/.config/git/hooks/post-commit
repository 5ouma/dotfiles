#!/usr/bin/env zsh

(! type op &>/dev/null) && exit

declare -r itemTitle='Notion Git Integration'
itemData="$(op item get "$itemTitle" --fields='label=database-id,credential')" && declare -r itemData
databaseId="$(echo "$itemData" | cut -d ',' -f 1)" && declare -r databaseId
credential="$(echo "$itemData" | cut -d ',' -f 2)" && declare -r credential

gitLog="$(git log -n 1 HEAD --format='%ad,%h,%s' --date=format:'%Y-%m-%d %H:%M:%S')" && declare -r gitLog
gitCommitDate="$(echo "$gitLog" | cut -d ',' -f 1)" && declare -r gitCommitDate
gitCommitHash="$(echo "$gitLog" | cut -d ',' -f 2)" && declare -r gitCommitHash
gitCommitMessage="$(echo "$gitLog" | cut -d ',' -f 3-)" && declare -r gitCommitMessage
gitRepoUrl="https://$(git config --get remote.origin.url | sed -E -e 's/(^ssh:\/\/|git@|\.git)//g' -e 's/:/\//')" && declare -r gitRepoUrl

notionData="$(
  cat <<EOF
{
  "parent": { "database_id": "$databaseId" },
  "properties": {
    "Message": { "title": [{ "text": { "content": "$gitCommitMessage" } }] },
    "Hash": { "rich_text": [{ "text": { "content": "$gitCommitHash" } }] },
    "URL": { "url": "$gitRepoUrl" },
    "Date": { "date": { "start": "$gitCommitDate", "time_zone": "Asia/Tokyo" } }
  }
}
EOF
)" && declare -r notionData

curl -s -X POST https://api.notion.com/v1/pages \
  -H "Authorization: Bearer $credential" \
  -H "Content-Type: application/json" \
  -H "Notion-Version: 2022-06-28" \
  --data "$notionData"
