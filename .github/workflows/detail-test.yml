name: üî¨ Detail Test

on:
  push:
    branches:
      - main
    paths:
      - .github/workflows/detail-test.yml
  pull_request:
    paths:
      - .github/workflows/detail-test.yml
  schedule:
    - cron: 0 0 * * SAT
  workflow_dispatch:

permissions: {}

jobs:
  test:
    name: ${{ startsWith(matrix.os, 'macOS-') && 'üçé' || 'üêß' }} ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    timeout-minutes: 20
    strategy:
      fail-fast: false
      matrix:
        os: [Ubuntu-Latest, macOS-Latest]

    steps:
      - name: üß∞ Install dependencies
        if: ${{ startsWith(matrix.os, 'Ubuntu-') }}
        run: |
          sudo apt-get install -y build-essential procps curl file git zsh
          sudo snap install --classic code

      - name: üç∫ Uninstall Homebrew related
        if: ${{ startsWith(matrix.os, 'macOS-') }}
        run: /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/uninstall.sh)"
        env:
          NONINTERACTIVE: 1

      - name: üì¶ Skip mas
        id: skip
        if: ${{ startsWith(matrix.os, 'macOS-') }}
        run: |
          HOMEBREW_BUNDLE_MAS_SKIP="$(curl -s "https://raw.githubusercontent.com/$GITHUB_REPOSITORY/${GITHUB_HEAD_REF:-HEAD}/data/Brewfile" | sed -nE 's/^mas.* ([0-9]+)/\1/gp' | tr '\n' ' ')"
          echo "HOMEBREW_BUNDLE_MAS_SKIP=$HOMEBREW_BUNDLE_MAS_SKIP" | tee -a "$GITHUB_OUTPUT"

      - name: ‚öôÔ∏è Run setup
        run: zsh <(curl "https://dot.5ouma.me/${GITHUB_HEAD_REF:-HEAD}") --yes
        env:
          SETUP_SKIP_LOGINGITHUBCLI: true
          SETUP_SKIP_RESTOREAPPSETTINGS: true
          HOMEBREW_BUNDLE_MAS_SKIP: ${{ steps.skip.outputs.HOMEBREW_BUNDLE_MAS_SKIP }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: üêö Launch new login shell
        run: exec zsh -ilexc exit
