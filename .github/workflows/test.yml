name: ğŸ§ª Test

on:
  push:
    branches:
      - main
    paths:
      - setup
      - .github/workflows/test.yml
  pull_request:
    paths:
      - setup
      - .github/workflows/test.yml

permissions: {}

jobs:
  test:
    name: ${{ startsWith(matrix.os, 'macOS-') && 'ğŸ' || 'ğŸ§' }} ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    timeout-minutes: 10
    strategy:
      fail-fast: false
      matrix:
        os: [Ubuntu-24.04, Ubuntu-24.04-ARM, macOS-15]

    steps:
      - name: ğŸº Set up Homebrew
        uses: Homebrew/actions/setup-homebrew@04a6d8cfe9d251e2afb78c5bdc6274ec9642aea2 # main # zizmor: ignore[stale-action-refs]

      - name: ğŸ”¨ Install tools via Homebrew
        run: |
          rm -fv /Library/Frameworks/Python.framework/Versions/3.12/bin/{2to3-3.12,idle3.12,pydoc3.12,python3.12,python3.12-config}
          brew install atuin mackup mise prek sheldon vim zoxide zsh

      - name: ğŸ Install macOS tools via Homebrew
        if: ${{ startsWith(matrix.os, 'macOS-') }}
        run: brew install batt 5ouma/tap/dorg 5ouma/tap/mksei 5ouma/tap/mli

      - name: âš™ï¸ Run setup
        run: zsh <(curl "https://dot.5ouma.me/${GITHUB_HEAD_REF:-HEAD}") --yes
        env:
          SETUP_SKIP_INSTALLAPPS: true
          SETUP_SKIP_RESTOREAPPSETTINGS: true
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸš Launch new login shell
        run: exec zsh -ilexc exit
