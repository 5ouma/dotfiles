name: Test

on:
  push:
    branches:
      - main
    paths:
      - "setup"
      - ".github/workflows/test.yml"
  pull_request:
    paths:
      - "setup"
      - ".github/workflows/test.yml"

jobs:
  Test:
    strategy:
      matrix:
        os: [Ubuntu-Latest, macOS-Latest]
    runs-on: ${{ matrix.os }}

    steps:
      - name: Setup Homebrew
        id: setup-homebrew
        uses: Homebrew/actions/setup-homebrew@master

      - name: Install tools via Homebrew
        run: |
          rm -fv /Library/Frameworks/Python.framework/Versions/3.12/bin/{2to3-3.12,idle3.12,pydoc3.12,python3.12,python3.12-config}
          brew install atuin gitlint mackup pre-commit rtx sheldon vim zoxide zsh
          [ "$(uname)" = 'Darwin' ] && brew install 5ouma/formula/mksei blacktop/tap/lporg || :

      - name: Run setup
        env:
          SHELL: null
          SETUP_SKIP_installApps: true
          SETUP_SKIP_installDavinciResolve: true
          SETUP_SKIP_loginGitHubCli: true
          SETUP_SKIP_restoreLaunchpad: true
        run: zsh <(curl -sL dotup.vercel.app/${GITHUB_HEAD_REF:-HEAD}) --yes

      - name: Launch New Login Shell
        run: exec zsh -ilexc exit
